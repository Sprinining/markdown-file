# 工厂扫描测试蓝牙协议

## 1.协议框架

| 序号 | 组成部分       | 数据长度(字节) | 说明                               |
| ---- | -------------- | -------------- | ---------------------------------- |
| 1    | **帧头**       | 1              | 固定为0x55                         |
| 2    | **协议版本**   | 1              | 用于扩展协议后兼容旧版本           |
| 3    | 命令字         | 2              | CMD，范围：0x8000~0x8FFF           |
| 4    | flag           | 1              | 0：操作成功，0xFF：操作失败        |
| 5    | 数据区长度     | 2              | 数据区字节长度                     |
| 6    | 数据区         | N              | 数据内容，如果需要转码统一使用utf8 |
| 7    | **数据区校验** | 2              | CRC-16/MODBUS算法                  |
| 8    | **帧尾**       | 1              | 固定为0xAA                         |

- 数据收发采用小端字节序

## 2.错误码回复

- 操作失败时，统一使用这种回复格式

| 组成部分   | 数据长度(字节) | 说明                                         |
| ---------- | -------------- | -------------------------------------------- |
| 命令字     | 2              | CMD，接收到指令后，使用相同的CMD进行回复     |
| flag       | 1              | 0xFF：表示操作失败                           |
| 数据区长度 | 2              | 数据区字节长度                               |
| 数据区     | N              | 错误信息(可以进一步定义前几个字节为错误类型) |

## 3.参数读写

### 3.1读取参数

- A向B发送

| 组成部分   | 数据长度(字节) | 说明 |
| ---------- | -------------- | ---- |
| 命令字     | 2              | CMD  |
| flag       | 1              | 0    |
| 数据区长度 | 2              | 0    |

- B向A回复

| 组成部分   | 数据长度(字节) | 说明                                    |
| ---------- | -------------- | --------------------------------------- |
| 命令字     | 2              | CMD                                     |
| flag       | 1              | 0：表示操作成功，操作失误见“错误码回复” |
| 数据区长度 | 2              | 数据区字节长度                          |
| 数据区     | N              | 读出的数据                              |

### 3.2写入参数

- A向B发送

| 组成部分   | 数据长度(字节) | 说明           |
| ---------- | -------------- | -------------- |
| 命令字     | 2              | CMD            |
| flag       | 1              | 0              |
| 数据区长度 | 2              | 数据区字节长度 |
| 数据区     | N              | 要写入的数据   |

- B向A回复

| 组成部分   | 数据长度(字节) | 说明                                    |
| ---------- | -------------- | --------------------------------------- |
| 命令字     | 2              | CMD                                     |
| flag       | 1              | 0：表示操作成功，操作失误见“错误码回复” |
| 数据区长度 | 2              | 0                                       |

### 3.3其他

- 不需要回复的情况

| 组成部分   | 数据长度(字节) | 说明           |
| ---------- | -------------- | -------------- |
| 命令字     | 2              | CMD            |
| flag       | 1              | 0              |
| 数据区长度 | 2              | 数据区字节长度 |
| 数据区     | N              | 数据内容       |

## 4.命令字

| 内容         | 读命令字 | 写命令字 | 数据长度(字节) | 数据区   | 说明                                  |
| ------------ | -------- | -------- | -------------- | -------- | ------------------------------------- |
| 上报扫码结果 |          | 0x8001   | N              | 条码内容 | PDA扫描成功后，只上传条码内容         |
| 上报扫描失败 |          | 0x8002   | 0              |          | PDA扫描失败后，通知上位机此次扫描失败 |
| 断开蓝牙     |          | 0x8003   | 0              |          | 上位机发从此命令与PDA断开蓝牙连接     |

